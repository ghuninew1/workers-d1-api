<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000" />
    <link
      rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/favicon.png"
    />
    <link
      rel="apple-touch-icon"
      type="image/x-icon"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/favicon.ico"
    />
    <link
      rel="manifest"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/manifest.json"
    />

    <title>GhuniNew</title>

    <style>
      body {
        place-items: center;
        margin: 0;
        padding: 0;
        font-family: tahoma, sans-serif;
        font-size: 14px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      li {
        list-style: none;
      }

      .info {
        text-align: center;
        padding: 10px;
        margin: 0 auto;
        align-items: center;
        width: 100%;
        max-width: 900px;
        transition: 0.5s;
      }

      .info #status {
        height: 15px;
        width: 15px;
        background-color: #bbb;
        border-radius: 50%;
        display: inline-block;
      }

      .info #status.online {
        background-color: green;
      }

      .info #status.offline {
        background-color: red;
      }

      .info .online {
        color: green;
      }

      .info .offline {
        color: red;
      }

      section {
        margin: 0 auto;
        align-items: center;
        transition: 0.5s;
      }

      button {
        background-color: #00532f;
        border: none;
        padding: 8px;
        margin: 5px;
        text-align: center;
        text-decoration: none;
        border-radius: 8px;
        cursor: pointer;
        color: #fff;
        font-weight: 600;
        transition: 0.3s;
      }

      button:last-child {
        background-color: #eb3820;
        color: #000;
      }

      button:hover {
        background-color: #00885d20;
        outline: 3px solid #dd5608;
        color: #000;
      }

      .data {
        font-size: 18px;
        color: #00885d;
        margin-bottom: 10px;
        text-align: center;
      }
      .status {
        align-items: center;
        text-align: center;
        padding: 10px;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 700;
      }

      .event {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        padding: 0;
        margin-top: 10px;
        transition: 0.3s;
        visibility: hidden;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin: 5px;
        border: 1px solid #ddd;
        max-width: 900px;
        align-items: center;
        justify-content: center;
        transition: 0.5s;
      }
      table thead {
        background-color: #544b41;
        color: #847e7e;
      }
      table thead th {
        padding: 0;
        text-align: center;
      }
      table tbody tr:nth-child(odd) {
        background-color: #eee;
      }
      table tbody tr:nth-child(even) {
        background-color: #fff;
      }
      table tbody td {
        padding: 0;
        text-align: center;
      }
      table tbody td:nth-child(1) {
        text-align: left;
      }
      .bbtn {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        margin: 0 auto;
        padding: 0;
        margin-top: 10px;
        transition: 0.5s;
      }
      input{
        padding: 5px;
        margin: 5px;
        border-radius: 5px;
        border: 1px solid #ddd;
        width: 80px;
        transition: 0.5s;
      }
      input:focus{
        outline: 3px solid #dd5608;
        width: 100px;
        transition: 0.5s;
      }
      #btconnect{
        transition: 0.5s;
      }
      #tabledb{
        transition: 0.5s;
      }
      #tabledb span {
        padding: 5px;
        margin: 5px;
        border: 1px solid #ddd;
        transition: 0.5s;
      }

    </style>
  </head>

  <body>
    <main class="info2">
      <div class="info">
        <h1 >API GNEW</h1>
        <br />
        <div class="data" >
          <span id="data">...Connecting</span>&nbsp;
          <span id="status"></span>
          <span id="res"></span>
        </div>
        <div>
          <p id="date"></p>
          <p id="error" style="color: red"></p>
        </div>

        <section class="event">
          
          <input type="text" id="inputdb" onchange="(e)=>{e.target.value}" />
          <button id="get">Get</button>          
          <button id="getdb">Get DB</button>
          <button id="create">Add DB</button>
        </section>
        <div id="btconnect">
          <button id="open">Connect</button>
          <button id="close">Close</button>
        </div>
        <section id="tabledb">
        </section>
        <hr />
          <table >
            <thead id="from">
              <tbody id="fromtbody"></tbody>
            </thead>
            <tbody id="events"></tbody>
          </table>
      </div>
    </main>
    <footer style="text-align: center;">
      <span style="font-size: small;">Â© 2023 GhuniNew</span>
    </footer>
    
    <script>
      let ws;

      const openId = document.querySelector("#open");
      const closeId = document.querySelector("#close");
      const getId = document.querySelector("#get");
      const getdbId = document.querySelector("#getdb");
      const createId = document.querySelector("#create");
      const updateId = document.querySelector("#update");
      const deleteId = document.querySelector("#delete");
      const cancelId = document.querySelector("#cancel");
      const addId = document.querySelector("#add");
      const inputdbId = document.querySelector("#inputdb");
      const tabledbId = document.querySelector("#tabledb");
      const fromId = document.querySelector("#from");
      const fromtbodyId = document.querySelector("#fromtbody");
      const eventsId = document.querySelector("#events");
      const dataId = document.querySelector("#data");
      const statusId = document.querySelector("#status");
      const resId = document.querySelector("#res");
      const dateId = document.querySelector("#date");
      const errorId = document.querySelector("#error");
      const btconnectId = document.querySelector("#btconnect");

      async function websocket(url) {
        ws = new WebSocket(url);

        if (!ws) {
          throw new Error("server didn't accept ws");
        }

        await ws.addEventListener("open", () => {
          console.log("Opened websocket");
          isConnect();
        });

        await ws.addEventListener("message", ({ data }) => {
          const { time, tasks, table, error } = JSON.parse(data);
          resId.innerText = Number(time).toFixed(2) + " ms";

          if (table) {
            table.forEach((tb) => {
              const item = document.createElement("span");
              item.innerText = JSON.stringify(tb.name ? tb.rootpage + ": " + tb.name  : table);
              eventsId.prepend(item);
            });
          }
          if (tasks) {
            const itemth = document.createElement("tr");
            const th = document.createElement("th");
            const th1 = document.createElement("th");
            const th2 = document.createElement("th");
            const th3 = document.createElement("th");
            const th4 = document.createElement("th");
            const th5 = document.createElement("th");
            th.innerText = "id";
            th1.innerText = "name";
            th2.innerText = "alt";
            th3.innerText = "imag";
            th4.innerText = "post_id";
            th5.innerText = "update_at";
            itemth.appendChild(th);
            itemth.appendChild(th1);
            itemth.appendChild(th2);
            itemth.appendChild(th3);
            itemth.appendChild(th4);
            itemth.appendChild(th5);
            fromId.appendChild(itemth);

            tasks.forEach((task) => {
            const item = document.createElement("tr");
            const td = document.createElement("td");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            const td3 = document.createElement("td");
            const td4 = document.createElement("td");
            const td5 = document.createElement("td");

            td.innerText = JSON.stringify(task.id && task.id);
            td1.innerText = JSON.stringify(task.name && task.name);
            td2.innerText = JSON.stringify(task.alt && task.alt);
            td3.innerText = JSON.stringify(task.imag && task.imag);
            td4.innerText = JSON.stringify(task.post_id && task.post_id);
            td5.innerText = JSON.stringify(task.update_at && task.update_at);

            item.appendChild(td);
            item.appendChild(td1);
            item.appendChild(td2);
            item.appendChild(td3);
            item.appendChild(td4);
            item.appendChild(td5);

            eventsId.appendChild(item);
          });
          }

          if (error) {
            setErrorMessage(error);
          }
        });

        await ws.addEventListener("close", () => {
          console.log("Closed websocket");
          disConnect();
        });
      }

      const url = new URL(window.location);
      url.protocol = location.protocol.replace("http", "ws");
      url.pathname = "/ws/";
      // websocket(url);

      
      getId.onclick = () => {
        const getdb = document.querySelector("#inputdb").value;
        ws.send(JSON.stringify({ data: "GET", getdb: getdb }));
      };

      getdbId.onclick = () => {
        const getdb = document.querySelector("#inputdb").value;
        ws.send(JSON.stringify({ data: "GETDB", getdb: getdb }));
      };

      createId.onclick = () => {
        const getdb = document.querySelector("#inputdb").value;
        const itemth = document.createElement("tr");
        const input = document.createElement("input");
        const input1 = document.createElement("input");
        const input2 = document.createElement("input");
        const input3 = document.createElement("input");
        const input4 = document.createElement("input");
        const input5 = document.createElement("span");

        const th = document.createElement("th");
        const th1 = document.createElement("th");
        const th2 = document.createElement("th");
        const th3 = document.createElement("th");
        const th4 = document.createElement("th");
        const th5 = document.createElement("th");

        const td = document.createElement("td");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        const td3 = document.createElement("td");
        const td4 = document.createElement("td");
        const td5 = document.createElement("td");

        itemth.setAttribute("id", "itemth");

        input.setAttribute("type", "number");
        input.setAttribute("id", "id");
        input.setAttribute("placeholder", "id");
        input.setAttribute("onchange", "(e)=>{e.target.value}");
        input1.setAttribute("type", "text");
        input1.setAttribute("id", "name");
        input1.setAttribute("placeholder", "name");
        input1.setAttribute("onchange", "(e)=>{e.target.value}");
        input2.setAttribute("type", "text");
        input2.setAttribute("id", "alt");
        input2.setAttribute("placeholder", "alt");
        input2.setAttribute("onchange", "(e)=>{e.target.value}");
        input3.setAttribute("type", "text");
        input3.setAttribute("id", "imag");
        input3.setAttribute("placeholder", "imag");
        input3.setAttribute("onchange", "(e)=>{e.target.value}");
        input4.setAttribute("type", "text");
        input4.setAttribute("id", "post_id");
        input4.setAttribute("placeholder", "post_id");
        input4.setAttribute("onchange", "(e)=>{e.target.value}");
        // input5.setAttribute("type", "text");
        input5.setAttribute("id", "update_at");
        // input5.setAttribute("placeholder", "update_at");

        td.appendChild(input);
        td1.appendChild(input1);
        td2.appendChild(input2);
        td3.appendChild(input3);
        td4.appendChild(input4);
        td5.appendChild(input5);

        itemth.appendChild(th);
        itemth.appendChild(th1);
        itemth.appendChild(th2);
        itemth.appendChild(th3);
        itemth.appendChild(th4);
        itemth.appendChild(th5);

        const tr2 = document.createElement("tr");

        tr2.appendChild(td);
        tr2.appendChild(td1);
        tr2.appendChild(td2);
        tr2.appendChild(td3);
        tr2.appendChild(td4);
        tr2.appendChild(td5);

        fromId.appendChild(itemth);
        fromId.appendChild(tr2);

        const button = document.createElement("button");
        button.setAttribute("id", "add");
        button.innerText = "Add";
        tabledbId.appendChild(button);

        document.getElementById("update_at").innerText = new Date().toLocaleString('th-TH');

        button.onclick = () => {
          const getid = document.querySelector("#id").value;
          const getname = document.querySelector("#name").value;
          const getalt = document.querySelector("#alt").value;
          const getimag = document.querySelector("#imag").value;
          const getpost_id = document.querySelector("#post_id").value;
          ws.send(
            JSON.stringify({
              data: "CREATE",
              getdb: getdb,
              getid: getid,
              getname: getname,
              getalt: getalt,
              getimag: getimag,
              getpost_id: getpost_id,
            })
          );
        };

        const button1 = document.createElement("button");
        button1.setAttribute("id", "update");
        button1.innerText = "Update";
        tabledbId.appendChild(button1);

        button1.onclick = () => {
          const getid = document.querySelector("#id").value;
          const getname = document.querySelector("#name").value;
          const getalt = document.querySelector("#alt").value;
          const getimag = document.querySelector("#imag").value;
          const getpost_id = document.querySelector("#post_id").value;
          ws.send(
            JSON.stringify({
              data: "UPDATE",
              getdb: getdb,
              getid: getid,
              getname: getname,
              getalt: getalt,
              getimag: getimag,
              getpost_id: getpost_id,
            })
          );
        };

        const button2 = document.createElement("button");
        button2.setAttribute("id", "delete");
        button2.innerText = "Delete";
        tabledbId.appendChild(button2);

        button2.onclick = () => {
          const getid = document.querySelector("#id").value;
          ws.send(
            JSON.stringify({
              data: "DELETE",
              getdb: getdb,
              getid: getid,
            })
          );
        };

        const cancel = document.createElement("button");
        cancel.setAttribute("id", "cancel");
        cancel.innerText = "Cancel";
        tabledbId.appendChild(cancel);

        cancel.onclick = () => {
          if (fromId.childNodes.length > 0) {
            while (fromId.firstChild) {
              fromId.removeChild(fromId.firstChild);
            }
          }
          if (fromtbodyId.childNodes.length > 0) {
            while (fromtbodyId.firstChild) {
              fromtbodyId.removeChild(fromtbodyId.firstChild);
            }
          }
          if (eventsId.childNodes.length > 0) {
            while (eventsId.firstChild) {
              eventsId.removeChild(eventsId.firstChild);
            }
          }
          if (tabledbId.childNodes.length > 0) {
            while (tabledbId.firstChild) {
              tabledbId.removeChild(tabledbId.firstChild);
            }
          } 
        };
      };
    
      //websocket reconnect
      openId.onclick = () => {
        websocket(url);
        isConnect();
      };

      closeId.onclick = () => {
        ws.close();
        ws = null;
        disConnect();
      };

      const isConnect = () =>{
        dataId.innerText = "Online";
        statusId.classList.add("online");
        statusId.classList.remove("offline");
        document.querySelector(".event").setAttribute("style", "visibility: visible;");
        dateId.innerText = new Date().toLocaleString('th-TH');
        btconnectId.classList.add("bbtn");
      }
      const disConnect =() => {
        dataId.innerText = "Offline";
        statusId.classList.add("offline");
        statusId.classList.remove("online");
        document.querySelector(".event").setAttribute("style", "visibility: hidden;");
        btconnectId.classList.remove("bbtn");
        errorId.innerText = "";
        dateId.innerText = "";
        eventsId.innerText = "";
        tabledbId.innerText = "";

      }

      const setErrorMessage = (message) => {
        errorId.innerHTML = message ? message : "";
      };
    </script>
  </body>
</html>
