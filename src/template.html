<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000" />
    <link
      rel="icon"
      type="image/png"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/favicon.png"
    />
    <link
      rel="apple-touch-icon"
      type="image/x-icon"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/favicon.ico"
    />
    <link
      rel="manifest"
      href="https://raw.githubusercontent.com/ghuninew1/ghuninew1/main/img/manifest.json"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <title>GhuniNew</title>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: tahoma, sans-serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      li {
        list-style: none;
      }

      #data {
        font-size: 22px;
        font-weight: 700;
        text-align: center;
      }
      .online {
        background-color: green;
      }
      .offline {
        background-color: red;
      }   

      #inputdb{
        margin: 10px;
        width: 80px;
        transition: 0.5s ease-in-out;
        padding: 0;
      }
      #inputdb:focus{
        outline: 2px solid palevioletred;
        width: 120%;
        transition: 0.5s ease-in-out;
      }

      button {
        margin: 0;
      }
      #btndb{
        display: none;
      }
      #close{
        display: none;
      }
      #fromtbody{
        text-align: center;
        align-items: center;
        justify-content: center;
      }
      .container-table {
        display: flex;
        flex-direction: column;
        width: 80%;
        align-items: center;
        justify-content: center;
        margin: auto;
        padding: 10px;
      }
      tr th {
        background-color: #656363 !important;
        color: #fff !important;
      }
    </style>
  </head>

  <body>
    <main >
      <div class="container text-center">
        <h1 >API GNEW</h1>
        <br />
        <div class="container-fluid" >
          <span id="data" >...Connecting</span>&nbsp;
          <span id="status" class="spinner-border "></span>
          <span id="res"></span>
        </div>
        <div>
          <p id="date"></p>
        </div>


        <div id="btconnect">
          <button id="open" class="btn btn-success btn-lg">Connect</button>
          <button id="close" class="btn btn-danger btn-lg">Close</button>
        </div>

        <div class="col align-items-md-center" id="btndb">
          <div class="col-md-4">
            <input class="form-control " type="text" id="inputdb" onchange="(e)=>{e.target.value}" />
          </div>
          <button id="get"class="btn btn-outline-primary" >Get Tb</button>          
          <button id="getdb" class="btn btn-outline-secondary">Get DB</button>

          <div class="btn-group" role="group" aria-label="Basic mixed styles example">
            <button id="add"  type="button" class="btn btn-danger">Add</button>
            <button id="update" type="button" class="btn btn-warning">Edit</button>
            <button id="delete" type="button" class="btn btn-success">Del</button>
          </div>

          <button id="cancel" class="btn btn-outline-dark">Reset</button>
          <hr />
          <section id="tabledb">
            <p id="success" style="color: green"></p>
            <p id="error" style="color: red"></p>
          </section>
        </div>
      </div>
    </main>
    <div class="container-table">
        <table class="table table-responsive-sm table-hover">
          <thead >
            <tbody id="fromtbody" class="table-responsive"></tbody>
            <tbody id="from" class="table-responsive"></tbody>
          </thead>
          <tbody id="events"></tbody>
        </table>
      </div>

    <footer style="text-align: center;">
      <span style="font-size: small;">Â© 2023 GhuniNew</span>
    </footer>
    
    <script>
      let ws;

      const openId = document.querySelector("#open");
      const closeId = document.querySelector("#close");
      const getId = document.querySelector("#get");
      const getdbId = document.querySelector("#getdb");
      const updateId = document.querySelector("#update");
      const deleteId = document.querySelector("#delete");
      const cancelId = document.querySelector("#cancel");
      const addId = document.querySelector("#add");
      const inputdbId = document.querySelector("#inputdb");
      const tabledbId = document.querySelector("#tabledb");
      const fromId = document.querySelector("#from");
      const fromtbodyId = document.querySelector("#fromtbody");
      const eventsId = document.querySelector("#events");
      const dataId = document.querySelector("#data");
      const statusId = document.querySelector("#status");
      const resId = document.querySelector("#res");
      const dateId = document.querySelector("#date");
      const errorId = document.querySelector("#error");
      const btconnectId = document.querySelector("#btconnect");
      const btndbId = document.querySelector("#btndb");
      const successId = document.querySelector("#success");

      async function websocket(url) {
        ws = new WebSocket(url);

        if (!ws) {
          throw new Error("server didn't accept ws");
        }

        await ws.addEventListener("open", () => {
          console.log("Opened websocket");
          isConnect();
        });

        await ws.addEventListener("message", ({ data }) => {
          const { time, tasks, table, success, error } = JSON.parse(data);
          resId.innerText = Number(time).toFixed(2) + " ms";

          console.log("Received message", success);

          if(success){
            document.querySelector("#success").innerText = success;
          }

          if (table) {

            table.forEach((tb) => {
              const list = document.createElement("tr");
              const item = document.createElement("th");
              const item2 = document.createElement("th");
              const item3 = document.createElement("th");
              item.innerText = JSON.stringify(tb.rootpage);
              item2.innerText = JSON.stringify(tb.name);
              item3.innerText = JSON.stringify(tb.sql);
              list.appendChild(item);
              list.appendChild(item2);
              list.appendChild(item3);
              eventsId.appendChild(list);
            });
          }
          if (tasks) {
            const itemth = document.createElement("tr");
            const th = document.createElement("th");
            const th1 = document.createElement("th");
            const th2 = document.createElement("th");
            const th3 = document.createElement("th");
            const th4 = document.createElement("th");
            const th5 = document.createElement("th");
            th.innerText = "id";
            th1.innerText = "name";
            th2.innerText = "alt";
            th3.innerText = "imag";
            th4.innerText = "post_id";
            th5.innerText = "update_at";
            itemth.appendChild(th);
            itemth.appendChild(th1);
            itemth.appendChild(th2);
            itemth.appendChild(th3);
            itemth.appendChild(th4);
            itemth.appendChild(th5);
            fromId.appendChild(itemth);

            tasks.forEach((task) => {
            const item = document.createElement("tr");
            const td = document.createElement("td");
            const td1 = document.createElement("td");
            const td2 = document.createElement("td");
            const td3 = document.createElement("td");
            const td4 = document.createElement("td");
            const td5 = document.createElement("td");

            td.innerText = JSON.stringify(task.id && task.id);
            td1.innerText = JSON.stringify(task.name && task.name);
            td2.innerText = JSON.stringify(task.alt && task.alt);
            td3.innerText = JSON.stringify(task.imag && task.imag);
            td4.innerText = JSON.stringify(task.post_id && task.post_id);
            td5.innerText = JSON.stringify(task.update_at && task.update_at);

            item.appendChild(td);
            item.appendChild(td1);
            item.appendChild(td2);
            item.appendChild(td3);
            item.appendChild(td4);
            item.appendChild(td5);

            eventsId.appendChild(item);
          });
          } 

          if (error) {
            setErrorMessage(error);
          }
        });

        await ws.addEventListener("close", () => {
          console.log("Closed websocket");
          disConnect();
        });
      }

      const url = new URL(window.location);
      url.protocol = location.protocol.replace("http", "ws");
      url.pathname = "/ws/";
      // websocket(url);
      // const url = "wss://api.bigbrain-studio.com/ws/";

      
      getId.onclick = () => {
        tableReset();
        const getdb = document.querySelector("#inputdb").value;
        ws.send(JSON.stringify({ data: "GET", getdb: getdb }));
      };

      getdbId.onclick = () => {
        tableReset();
        const getdb = document.querySelector("#inputdb").value;
        ws.send(JSON.stringify({ data: "GETDB", getdb: getdb }));
      };

      const createId = () => {
        const getdb = document.querySelector("#inputdb").value;
        const itemth = document.createElement("tr");
        const fromBodytr = document.createElement("tr");
        const input = document.createElement("input");
        const input1 = document.createElement("input");
        const input2 = document.createElement("input");
        const input3 = document.createElement("input");
        const input4 = document.createElement("input");
        const input5 = document.createElement("span");

        const th = document.createElement("th");
        const th1 = document.createElement("th");
        const th2 = document.createElement("th");
        const th3 = document.createElement("th");
        const th4 = document.createElement("th");
        const th5 = document.createElement("th");

        th.innerText = "id";
        th1.innerText = "name";
        th2.innerText = "alt";
        th3.innerText = "imag";
        th4.innerText = "post_id";
        th5.innerText = new Date().toLocaleString('th-TH');

        fromBodytr.appendChild(th);
        fromBodytr.appendChild(th1);
        fromBodytr.appendChild(th2);
        fromBodytr.appendChild(th3);
        fromBodytr.appendChild(th4);
        fromBodytr.appendChild(th5);

        fromtbodyId.appendChild(fromBodytr);

        const td = document.createElement("td");
        const td1 = document.createElement("td");
        const td2 = document.createElement("td");
        const td3 = document.createElement("td");
        const td4 = document.createElement("td");
        const td5 = document.createElement("td");

        itemth.setAttribute("id", "itemth");

        input.setAttribute("type", "number");
        input.setAttribute("id", "id");
        input.setAttribute("placeholder", "id");
        input.setAttribute("onchange", "(e)=>{e.target.value}");
        input1.setAttribute("type", "text");
        input1.setAttribute("id", "name");
        input1.setAttribute("placeholder", "name");
        input1.setAttribute("onchange", "(e)=>{e.target.value}");
        input2.setAttribute("type", "text");
        input2.setAttribute("id", "alt");
        input2.setAttribute("placeholder", "alt");
        input2.setAttribute("onchange", "(e)=>{e.target.value}");
        input3.setAttribute("type", "text");
        input3.setAttribute("id", "imag");
        input3.setAttribute("placeholder", "imag");
        input3.setAttribute("onchange", "(e)=>{e.target.value}");
        input4.setAttribute("type", "text");
        input4.setAttribute("id", "post_id");
        input4.setAttribute("placeholder", "post_id");
        input4.setAttribute("onchange", "(e)=>{e.target.value}");
        input5.setAttribute("id", "update_at");

        td.appendChild(input);
        td1.appendChild(input1);
        td2.appendChild(input2);
        td3.appendChild(input3);
        td4.appendChild(input4);
        td5.appendChild(input5);

        const tr2 = document.createElement("tr");

        tr2.appendChild(td);
        tr2.appendChild(td1);
        tr2.appendChild(td2);
        tr2.appendChild(td3);
        tr2.appendChild(td4);
        tr2.appendChild(td5);

        fromId.appendChild(itemth);
        fromId.appendChild(tr2);
      };

        const addTable = () => {
          const getdb = document.querySelector("#inputdb").value;
          const getname = document.querySelector("#name").value;
          const getalt = document.querySelector("#alt").value;
          const getimag = document.querySelector("#imag").value;
          const getpost_id = document.querySelector("#post_id").value;
          ws.send(
            JSON.stringify({
              data: "CREATE",
              getdb: getdb,
              getname: getname,
              getalt: getalt,
              getimag: getimag,
              getpost_id: getpost_id,
            })
          );
        };

        addId.onclick = () => {
          tableReset();
          createId();
          const button = document.createElement("button");
          button.setAttribute("id", "addtable");
          button.innerText = "Add Now";
          document.querySelector("#update_at").appendChild(button);
          document.querySelector("#id").setAttribute("disabled", "disabled");
          button.setAttribute("class", "btn btn-outline-success");

          button.onclick = () => {
            addTable();
          };
        };
        
        const updateTable = ()=>{
          const getdb = document.querySelector("#inputdb").value;
          const getid = document.querySelector("#id").value;
          const getname = document.querySelector("#name").value;
          const getalt = document.querySelector("#alt").value;
          const getimag = document.querySelector("#imag").value;
          const getpost_id = document.querySelector("#post_id").value;
          ws.send(
            JSON.stringify({
              data: "UPDATE",
              getdb: getdb,
              getid: getid,
              getname: getname,
              getalt: getalt,
              getimag: getimag,
              getpost_id: getpost_id,
            })
          );
        };

        updateId.onclick = () => {
          tableReset();
          createId();
          const button = document.createElement("button");
          button.setAttribute("id", "updatetable");
          button.innerText = "Update Now";
          document.querySelector("#update_at").appendChild(button);
          button.setAttribute("class", "btn btn-outline-success");

          button.onclick = () => {
            updateTable();
          };
        };

        const deleteTable = () => {
          const getdb = document.querySelector("#inputdb").value;
          const getid = document.querySelector("#id").value;
          ws.send(
            JSON.stringify({
              data: "DELETE",
              getdb: getdb,
              getid: getid,
            })
          );
        };

        deleteId.onclick = () => {
          tableReset();
          createId();
          const button = document.createElement("button");
          button.setAttribute("id", "deletetable");
          button.innerText = "Delete Now";
          document.querySelector("#update_at").appendChild(button);
          document.querySelector("#name").setAttribute("disabled", "disabled");
          document.querySelector("#alt").setAttribute("disabled", "disabled");
          document.querySelector("#imag").setAttribute("disabled", "disabled");
          document.querySelector("#post_id").setAttribute("disabled", "disabled");
          button.setAttribute("class", "btn btn-outline-success");

          button.onclick = () => {
            deleteTable();
          };
        };

        const tableReset =()=> {
          if (fromId.childNodes.length > 0) {
            while (fromId.firstChild) {
              fromId.removeChild(fromId.firstChild);
            }
          }
          if (fromtbodyId.childNodes.length > 0) {
            while (fromtbodyId.firstChild) {
              fromtbodyId.removeChild(fromtbodyId.firstChild);
            }
          }
          if (eventsId.childNodes.length > 0) {
            while (eventsId.firstChild) {
              eventsId.removeChild(eventsId.firstChild);
            }
          }
          if (tabledbId.childNodes.length > 0) {
            while (tabledbId.firstChild) {
              tabledbId.removeChild(tabledbId.firstChild);
            }
          } 
        }

        cancelId.onclick = () => {
          tableReset();
        };

      //websocket reconnect
      openId.onclick = () => {
        websocket(url);
        isConnect();
        tableReset();
      };

      closeId.onclick = () => {
        ws.close();
        ws = null;
        disConnect();
        tableReset();
      };

      const isConnect = () =>{
        dataId.innerText = "Online";
        dataId.style.color = "green";
        statusId.classList.add("text-success");
        statusId.classList.add("online");
        statusId.classList.remove("offline");
        statusId.classList.remove("text-danger");
        btndbId.style.display = "inline-block";
        dateId.innerText = new Date().toLocaleString('th-TH');
        btconnectId.classList.add("bbtn");
        btndbId.style.display = "inline-block";
        closeId.style.display = "inline-block";
        openId.style.display = "none";
        inputdbId.setAttribute("placeholder", "Search DB");
      }
      const disConnect =() => {
        dataId.innerText = "Offline";
        dataId.style.color = "red";
        statusId.classList.add("text-danger");
        statusId.classList.add("offline");
        statusId.classList.remove("online");
        statusId.classList.remove("text-success");
        eventsId.style.display = "none";
        btconnectId.classList.remove("bbtn");
        errorId.innerText = "";
        dateId.innerText = "";
        eventsId.innerText = "";
        tabledbId.innerText = "";
        btndbId.style.display = "none";
        closeId.style.display = "none";
        openId.style.display = "inline-block";
      }

      const setErrorMessage = (message) => {
        errorId.innerHTML = message ? message : "";
      };
    </script>
  </body>
</html>
